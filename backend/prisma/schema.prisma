// =========================
//  Prisma Schema - Appointly MVP (UPDATED FINAL)
// =========================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================
//  ENUMS
// =========================

enum Role {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

// =========================
//  MODELS
// =========================

// USERS - both customers + providers
model User {
  id          String         @id @default(uuid())
  email       String         @unique
  password    String?        // Optional for OAuth users
  fullName    String
  role        Role           @default(CUSTOMER)
  avatarUrl   String?        // Supabase Storage URL for avatar

  // Contact & Location (optional for all users)
  phone       String?
  address     String?
  city        String?
  district    String?

  // OAuth
  provider    AuthProvider   @default(LOCAL)
  googleId    String?        @unique

  // Email Verification
  emailVerified             Boolean   @default(false)
  verificationToken         String?   // One-time use token
  tokenExpiry               DateTime? // Token expires after 30 minutes
  lastVerificationEmailSent DateTime? // For rate limiting resends

  // Password Reset
  resetPasswordToken        String?   // One-time use reset token
  resetPasswordExpiry       DateTime? // Reset token expires after 30 minutes
  lastResetEmailSent        DateTime? // For rate limiting reset emails

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  providerProfile BusinessProvider?
  appointments     Appointment[]
  notifications    Notification[]
  bookmarks        Bookmark[]
}

// PROVIDER PROFILE
model BusinessProvider {
  id            String           @id @default(uuid())
  userId        String           @unique
  businessName  String           // Company official full name
  nickname      String           // Company nickname (display name shown to customers)
  category      String
  phone         String?
  description   String?

  // Location
  address       String?
  city          String?
  district      String?
  latitude      Float?
  longitude     Float?

  // Booking Configuration
  slotInterval       Int          @default(30)  // Time slot interval: 15, 30, or 60 minutes
  bookingWindowWeeks Int          @default(1)   // How many weeks ahead customers can book: 1-4
  cancellationHours  Int          @default(24)  // How many hours before appointment customers can cancel

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  services      Service[]
  hours         WorkingHours[]
  appointments  Appointment[]
  notifications Notification[]
  bookmarkedBy  Bookmark[]
}

// SERVICES OFFERED BY PROVIDERS
model Service {
  id          String        @id @default(uuid())
  providerId  String
  name        String
  duration    Int
  price       Int
  description String?

  provider    BusinessProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  appointments Appointment[]
}

// DATE-SPECIFIC SCHEDULES
model WorkingHours {
  id           String   @id @default(uuid())
  providerId   String
  date         DateTime
  openTime     String
  closeTime    String

  provider     BusinessProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
}

// APPOINTMENTS
model Appointment {
  id             String             @id @default(uuid())
  customerId     String
  providerId     String
  serviceId      String
  appointmentTime DateTime
  status         AppointmentStatus  @default(PENDING)
  notes          String?
  cancellationReason String?        // Reason for cancellation (provider-provided)

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  customer      User             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  provider      BusinessProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  service       Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  notifications Notification[]
}

// AUDIT LOGS - Track all user actions
model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String   // LOGIN, BOOKING_CREATED, BOOKING_CANCELLED, PROFILE_UPDATED, etc
  entityId  String?  // ID of affected resource (booking ID, profile ID, etc)
  details   Json?    // Additional details about the action
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@index([action])
}

// NOTIFICATIONS - Inbox/Notification system
model Notification {
  id         String   @id @default(uuid())
  userId     String   // Recipient
  type       String   // BOOKING_CONFIRMED, BOOKING_CANCELLED, PROMOTION, REMINDER, etc
  title      String
  message    String   @db.Text
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Optional relationships
  bookingId  String?
  providerId String?

  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking    Appointment?      @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  provider   BusinessProvider? @relation(fields: [providerId], references: [id], onDelete: SetNull)

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

// BOOKMARKS - Save favorite providers
model Bookmark {
  id         String   @id @default(uuid())
  userId     String   // Customer who bookmarked
  providerId String   // Business that was bookmarked
  createdAt  DateTime @default(now())

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider BusinessProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([userId, providerId]) // Prevent duplicate bookmarks
  @@index([userId])
  @@index([providerId])
}
